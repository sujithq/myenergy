@using myenergy.Models
@using myenergy.Services
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject AppConfigurationService ConfigService

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">‚è±Ô∏è 15-Minute Interval Data - @DetailData.Date.ToString("dddd, MMMM dd, yyyy")</h5>
    </div>
    <div class="card-body">
        <!-- Chart Controls -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="chartView" class="form-label">View:</label>
                <select id="chartView" class="form-select form-select-sm" @bind="SelectedView" @bind:after="UpdateChart">
                    <option value="@ChartView.Production">Solar Production</option>
                    <option value="@ChartView.Consumption">Total Consumption</option>
                    <option value="@ChartView.Grid">Grid Usage & Injection</option>
                    <option value="@ChartView.All">All Metrics</option>
                    <option value="@ChartView.Gas">Gas Usage</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="chartStyle" class="form-label">Style:</label>
                <select id="chartStyle" class="form-select form-select-sm" @bind="ChartStyle" @bind:after="UpdateChart">
                    <option value="line">Line Chart</option>
                    <option value="bar">Bar Chart</option>
                    <option value="area">Area Chart</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="showSunrise" @bind="ShowSunriseSunset" @bind:after="UpdateChart">
                    <label class="form-check-label" for="showSunrise">
                        Show Sunrise/Sunset
                    </label>
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="chart-container" style="position: relative; height: 450px;">
            <canvas id="@ChartCanvasId" style="max-height: 450px;"></canvas>
        </div>

        <!-- Summary Stats -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Daily Summary</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Total Production:</strong><br/>
                                <span class="text-success">@DetailData.TotalProduction.ToString("N2") kWh</span><br/>
                                <small class="text-muted">Peak: @DetailData.PeakProduction.ToString("N2") kWh/15min</small>
                            </div>
                            <div class="col-md-3">
                                <strong>Total Consumption:</strong><br/>
                                <span class="text-danger">@DetailData.TotalConsumption.ToString("N2") kWh</span><br/>
                                <small class="text-muted">Peak: @DetailData.PeakConsumption.ToString("N2") kWh/15min</small>
                            </div>
                            <div class="col-md-3">
                                <strong>Grid Import:</strong><br/>
                                <span class="text-info">@DetailData.TotalGridImport.ToString("N2") kWh</span><br/>
                                <small class="text-muted">Injection: @DetailData.TotalInjection.ToString("N2") kWh</small>
                            </div>
                            <div class="col-md-3">
                                <strong>Gas Usage:</strong><br/>
                                <span class="text-danger">@DetailData.TotalGasUsage.ToString("N2") m¬≥</span><br/>
                                @if (ConfigService.IsSunTimesDisplayEnabled && DetailData.SunTimes != null)
                                {
                                    <small class="text-muted">‚òÄÔ∏è @DetailData.SunTimes.R.ToString("HH:mm") - @DetailData.SunTimes.S.ToString("HH:mm")</small>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather Info -->
        @if (DetailData.Weather != null)
        {
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Weather Conditions</h6>
                            <div class="row">
                                <div class="col-md-2">
                                    <strong>Temperature:</strong><br/>
                                    <span>Avg: @DetailData.Weather.tavg.ToString("N1")¬∞C</span><br/>
                                    <small class="text-muted">@DetailData.Weather.tmin.ToString("N1")¬∞C - @DetailData.Weather.tmax.ToString("N1")¬∞C</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>Precipitation:</strong><br/>
                                    <span>@DetailData.Weather.prcp.ToString("N1") mm</span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Wind:</strong><br/>
                                    <span>@DetailData.Weather.wspd.ToString("N1") km/h</span><br/>
                                    <small class="text-muted">Gust: @DetailData.Weather.wpgt.ToString("N1") km/h</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>Pressure:</strong><br/>
                                    <span>@DetailData.Weather.pres.ToString("N1") hPa</span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Sunshine:</strong><br/>
                                    <span>@((DetailData.Weather.tsun / 60).ToString("N1")) hours</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Dynamic Pricing Chart -->
        @if (ShowDynamicPricing && OdsPricingData != null && OdsPricingData.Any())
        {
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">üí∂ ODS Dynamic Pricing - 15-Minute Intervals</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="@PriceChartCanvasId" style="max-height: 300px;"></canvas>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Pricing Summary</h6>
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <strong>Import Price:</strong><br/>
                                                    <span class="text-danger">Avg: ‚Ç¨@(OdsPricingData.Average(p => p.ImportPricePerKwh).ToString("F4"))/kWh</span><br/>
                                                    <small class="text-muted">‚Ç¨@((OdsPricingData.Average(p => p.ImportPricePerKwh) * 1000).ToString("F2"))/MWh</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Export Price:</strong><br/>
                                                    <span class="text-success">Avg: ‚Ç¨@(OdsPricingData.Average(p => p.InjectionPricePerKwh).ToString("F4"))/kWh</span><br/>
                                                    <small class="text-muted">‚Ç¨@((OdsPricingData.Average(p => p.InjectionPricePerKwh) * 1000).ToString("F2"))/MWh</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Import Range:</strong><br/>
                                                    <span>‚Ç¨@(OdsPricingData.Min(p => p.ImportPricePerKwh).ToString("F4")) - ‚Ç¨@(OdsPricingData.Max(p => p.ImportPricePerKwh).ToString("F4"))/kWh</span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Export Range:</strong><br/>
                                                    <span>‚Ç¨@(OdsPricingData.Min(p => p.InjectionPricePerKwh).ToString("F4")) - ‚Ç¨@(OdsPricingData.Max(p => p.InjectionPricePerKwh).ToString("F4"))/kWh</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (ShowDynamicPricing && (OdsPricingData == null || !OdsPricingData.Any()))
        {
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        No ODS pricing data available for @DetailData.Date.ToString("yyyy-MM-dd"). 
                        This date may be outside the available ODS data range.
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public DailyDetailData DetailData { get; set; } = default!;
    [Parameter] public bool ShowDynamicPricing { get; set; } = false;
    [Parameter] public List<OdsPricing> OdsPricingData { get; set; } = new();
    
    private string ChartCanvasId = Guid.NewGuid().ToString();
    private string PriceChartCanvasId = Guid.NewGuid().ToString(); // NEW
    private ChartView SelectedView = ChartView.All;
    private string ChartStyle = "line";
    private bool ShowSunriseSunset = true;

    public enum ChartView
    {
        Production,
        Consumption,
        Grid,
        All,
        Gas
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        await CreateChart();
        if (ShowDynamicPricing && OdsPricingData != null && OdsPricingData.Any())
        {
            await CreatePriceChart();
        }
    }
}

protected override async Task OnParametersSetAsync()
{
    await CreateChart();
    if (ShowDynamicPricing && OdsPricingData != null && OdsPricingData.Any())
    {
        await CreatePriceChart();
    }
}

private async Task CreatePriceChart()
{
    if (OdsPricingData == null || !OdsPricingData.Any())
        return;

    try
    {
        var chartConfig = GeneratePriceChartConfig();
        await JSRuntime.InvokeVoidAsync("createChart", PriceChartCanvasId, chartConfig);
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error creating price chart: {ex.Message}");
    }
}

private object GeneratePriceChartConfig()
{
    var labels = OdsPricingData.Select(p => p.DateTime.ToString("HH:mm")).ToArray();

    // Create anonymous list to avoid Razor parsing issues
    var importData = new {
        label = "Import Price (‚Ç¨/kWh)",
        data = OdsPricingData.Select(p => p.ImportPricePerKwh).ToArray(),
        borderColor = "rgb(220, 53, 69)",
        backgroundColor = "rgba(220, 53, 69, 0.1)",
        borderWidth = 2,
        fill = true,
        tension = 0.4,
        yAxisID = "y"
    };

    var exportData = new {
        label = "Export Price (‚Ç¨/kWh)",
        data = OdsPricingData.Select(p => p.InjectionPricePerKwh).ToArray(),
        borderColor = "rgb(40, 167, 69)",
        backgroundColor = "rgba(40, 167, 69, 0.1)",
        borderWidth = 2,
        fill = true,
        tension = 0.4,
        yAxisID = "y"
    };

    return new {
        type = "line",
        data = new {
            labels = labels,
            datasets = new[] { importData, exportData }
        },
        options = new {
            responsive = true,
            maintainAspectRatio = false,
            interaction = new {
                mode = "index",
                intersect = false
            },
            plugins = new {
                title = new {
                    display = true,
                    text = $"ODS Dynamic Pricing - {DetailData.Date:yyyy-MM-dd}"
                },
                legend = new {
                    display = true,
                    position = "top"
                },
                tooltip = new {
                    callbacks = new { }
                }
            },
            scales = new {
                y = new {
                    beginAtZero = false,
                    title = new {
                        display = true,
                        text = "Price (‚Ç¨/kWh)"
                    }
                }
            }
        }
    };
}

    private async Task UpdateChart()
    {
        await CreateChart();
    }

    private async Task CreateChart()
    {
        if (DetailData == null || !DetailData.QuarterHours.Any())
            return;

        try
        {
            var chartConfig = GenerateChartConfig();
            await JSRuntime.InvokeVoidAsync("createChart", ChartCanvasId, chartConfig);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating chart: {ex.Message}");
        }
    }

    private object GenerateChartConfig()
    {
        var labels = DetailData.QuarterHours.Select(q => q.Time.ToString("HH:mm")).ToArray();
        var datasets = new List<object>();

        var fill = ChartStyle == "area";

        if (SelectedView == ChartView.Production || SelectedView == ChartView.All)
        {
            datasets.Add(new {
                label = "Solar Production (kWh/15min)",
                data = DetailData.QuarterHours.Select(q => q.ActualProduction).ToArray(),
                borderColor = "rgb(255, 255, 0)",
                backgroundColor = ChartStyle == "area" ? "rgba(255, 255, 0, 0.3)" : "rgba(255, 255, 0, 0.8)",
                borderWidth = ChartStyle == "bar" ? 0 : 3,
                fill = fill,
                tension = 0.1
            });
        }

        if (SelectedView == ChartView.Consumption || SelectedView == ChartView.All)
        {
            datasets.Add(new {
                label = "Total Consumption (kWh/15min)",
                data = DetailData.QuarterHours.Select(q => q.TotalConsumption).ToArray(),
                borderColor = "rgb(0, 0, 255)",
                backgroundColor = ChartStyle == "area" ? "rgba(0, 0, 255, 0.3)" : "rgba(0, 0, 255, 0.8)",
                borderWidth = ChartStyle == "bar" ? 0 : 2,
                fill = fill,
                tension = 0.1
            });
        }

        if (SelectedView == ChartView.Grid || SelectedView == ChartView.All)
        {
            datasets.Add(new {
                label = "Grid Import (kWh/15min)",
                data = DetailData.QuarterHours.Select(q => q.ActualGridImport).ToArray(),
                borderColor = "rgb(255, 0, 0)",
                backgroundColor = ChartStyle == "area" ? "rgba(255, 0, 0, 0.3)" : "rgba(255, 0, 0, 0.8)",
                borderWidth = ChartStyle == "bar" ? 0 : 2,
                fill = fill,
                tension = 0.1
            });

            datasets.Add(new {
                label = "Grid Injection (kWh/15min)",
                data = DetailData.QuarterHours.Select(q => q.ActualInjection).ToArray(),
                borderColor = "rgb(0, 255, 0)",
                backgroundColor = ChartStyle == "area" ? "rgba(0, 255, 0, 0.3)" : "rgba(0, 255, 0, 0.8)",
                borderWidth = ChartStyle == "bar" ? 0 : 3,
                fill = fill,
                tension = 0.1
            });
        }

        if (SelectedView == ChartView.Gas || SelectedView == ChartView.All)
        {
            datasets.Add(new {
                label = "Gas Usage (m¬≥/15min)",
                data = DetailData.QuarterHours.Select(q => q.ActualGasUsage).ToArray(),
                borderColor = "rgb(255, 165, 0)",
                backgroundColor = ChartStyle == "area" ? "rgba(255, 165, 0, 0.3)" : "rgba(255, 165, 0, 0.8)",
                borderWidth = ChartStyle == "bar" ? 0 : 2,
                fill = fill,
                tension = 0.1,
                yAxisID = "y1"
            });
        }

        // Add sunrise/sunset markers if enabled
        var annotations = new List<object>();
        if (ShowSunriseSunset && DetailData.SunTimes != null)
        {
            var sunriseLabel = DetailData.SunTimes.R.ToString("HH:mm");
            var sunsetLabel = DetailData.SunTimes.S.ToString("HH:mm");

            annotations.Add(new {
                type = "line",
                xMin = sunriseLabel,
                xMax = sunriseLabel,
                borderColor = "rgba(255, 193, 7, 0.8)",
                borderWidth = 2,
                borderDash = new[] { 5, 5 },
                label = new {
                    display = true,
                    content = "‚òÄÔ∏è Sunrise",
                    position = "start"
                }
            });

            annotations.Add(new {
                type = "line",
                xMin = sunsetLabel,
                xMax = sunsetLabel,
                borderColor = "rgba(255, 152, 0, 0.8)",
                borderWidth = 2,
                borderDash = new[] { 5, 5 },
                label = new {
                    display = true,
                    content = "üåÖ Sunset",
                    position = "end"
                }
            });
        }

        object scales;
        
        if (SelectedView == ChartView.Gas || (SelectedView == ChartView.All && DetailData.TotalGasUsage > 0))
        {
            scales = new {
                y = new {
                    beginAtZero = true,
                    title = new {
                        display = true,
                        text = "Energy (kWh/15min)"
                    }
                },
                y1 = new {
                    type = "linear",
                    display = true,
                    position = "right",
                    beginAtZero = true,
                    title = new {
                        display = true,
                        text = "Gas (m¬≥/15min)"
                    },
                    grid = new {
                        drawOnChartArea = false
                    }
                }
            };
        }
        else
        {
            scales = new {
                y = new {
                    beginAtZero = true,
                    title = new {
                        display = true,
                        text = "Energy (kWh/15min)"
                    }
                }
            };
        }

        return new {
            type = ChartStyle == "area" ? "line" : ChartStyle,
            data = new {
                labels = labels,
                datasets = datasets.ToArray()
            },
            options = new {
                responsive = true,
                maintainAspectRatio = false,
                interaction = new {
                    mode = "index",
                    intersect = false
                },
                plugins = new {
                    title = new {
                        display = true,
                        text = $"15-Minute Energy Data - {DetailData.Date:yyyy-MM-dd}"
                    },
                    legend = new {
                        display = true,
                        position = "top"
                    },
                    tooltip = new {
                        callbacks = new { }
                    },
                    annotation = new {
                        annotations = annotations.ToArray()
                    }
                },
                scales = scales
            }
        };
    }
}